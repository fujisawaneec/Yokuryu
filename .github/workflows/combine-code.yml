name: Generate & Publish Combined Code File

on:
  push:
    branches:
      - master
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# ğŸ’¡ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°
env:
  # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
  OUTPUT_FILENAME: combined.txt
  # å‡ºåŠ›å…ˆãƒ–ãƒ©ãƒ³ãƒå
  TARGET_BRANCH: combine-code
  # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ‹¡å¼µå­
  TARGET_EXTENSIONS: .cpp,.h,.hpp,.vcxproj,.vcxproj.filters
  # é™¤å¤–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  EXCLUDE_DIRS: externals,resources

jobs:
  publish:
    runs-on: ubuntu-latest
    
    # ğŸ’¡ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦ãªæ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
    permissions:
      contents: write 

    steps:
      - name: Checkout master (Shallow depth)
        # çµåˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§shallow cloneï¼‰
        uses: actions/checkout@v4 

      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰çµåˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
      - name: Generate Code Summary
        id: generate
        shell: python
        run: |
          import os
          
          # --- ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®è¨­å®šèª­ã¿è¾¼ã¿ ---
          target_extensions = tuple(os.environ['TARGET_EXTENSIONS'].split(','))
          exclude_dirs = set(os.environ['EXCLUDE_DIRS'].split(','))
          output_file = os.environ['OUTPUT_FILENAME']
          root_dir = '.'
          exclude_dirs.update({'.git', '.github', '.vs', 'build', 'out'})

          def generate_tree_string(startpath):
              tree_lines = ["### ğŸŒ³ Codebase File Tree (Physical Structure)\n"]
              for root, dirs, files in os.walk(startpath):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  level = root.replace(startpath, '').count(os.sep)
                  indent = 'â”‚   ' * (level)
                  tree_lines.append(f'{indent}â”œâ”€â”€ {os.path.basename(root)}/')
                  sub_indent = 'â”‚   ' * (level + 1)
                  for f in files:
                      if f.endswith(target_extensions):
                          tree_lines.append(f'{sub_indent}â””â”€â”€ {f}')
              return "\n".join(tree_lines)

          def generate_summary():
              with open(output_file, 'w', encoding='utf-8') as out:
                  # A. ãƒ„ãƒªãƒ¼æ§‹é€ ï¼ˆç‰©ç†éšå±¤ã®æŠŠæ¡ç”¨ï¼‰
                  out.write(generate_tree_string(root_dir))
                  out.write("\n\n" + "="*60 + "\n")
                  out.write("FILE CONTENTS START BELOW\n")
                  out.write("="*60 + "\n\n")

                  # B. ãƒ•ã‚¡ã‚¤ãƒ«åé›†
                  all_files_paths = []
                  for root, dirs, files in os.walk(root_dir):
                      dirs[:] = [d for d in dirs if d not in exclude_dirs]
                      for file in files:
                          if file.endswith(target_extensions):
                              all_files_paths.append(os.path.join(root, file))

                  # C. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¾Œã«ä¸¦ã³æ›¿ãˆ
                  # AIãŒã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ï¼‰ã€ã‚’å…ˆã«èª­ã‚“ã§ã‹ã‚‰ã€Œä¸­èº«ã€ã‚’èª­ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹
                  all_files_paths.sort(key=lambda x: (
                      not x.endswith('.vcxproj'), 
                      not x.endswith('.filters'), 
                      x
                  ))

                  # D. XMLã‚¿ã‚°å½¢å¼ã§æ›¸ãå‡ºã—
                  for path in all_files_paths:
                      rel_path = os.path.relpath(path, root_dir)
                      try:
                          with open(path, 'r', encoding='utf-8', errors='ignore') as f:
                              content = f.read()
                              # <file_content>ã‚¿ã‚°ã§å›²ã‚€ã“ã¨ã§AIãŒå¢ƒç•Œã‚’100%èª¤èªã—ãªããªã‚‹
                              out.write(f'<file_content path="{rel_path}">\n')
                              out.write(content)
                              out.write(f'\n</file_content>\n\n')
                      except Exception as e:
                          print(f"Failed to read {rel_path}: {e}")

          generate_summary()

      # 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¬é–‹
      - name: Publish to Target Branch
        run: |
          # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚é€€é¿
          cp "$OUTPUT_FILENAME" /tmp/"$OUTPUT_FILENAME"
          
          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã®å­˜åœ¨ç¢ºèªã¨åˆ‡ã‚Šæ›¿ãˆ
          if git fetch origin "$TARGET_BRANCH"; then
            git checkout "$TARGET_BRANCH"
            git pull origin "$TARGET_BRANCH"
          else
            # åˆå›ä½œæˆæ™‚ã¯ orphan ãƒ–ãƒ©ãƒ³ãƒã§å±¥æ­´ã‚’æ±šã•ãšä½œæˆ
            git checkout --orphan "$TARGET_BRANCH"
            git rm -rf .
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒ
          mv /tmp/"$OUTPUT_FILENAME" .
          
          # ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT_FILENAME"
          
          # å·®åˆ†ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if ! git diff --cached --exit-code; then
            git commit -m "Auto: Update combined code for AI review (${{ github.sha }})"
            git push origin "$TARGET_BRANCH"
          else
            echo "No changes to commit"
          fi