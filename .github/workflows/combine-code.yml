name: Generate & Publish Combined Code File

on:
  # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches:
      - master
  # Actionsã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•ã§ã®å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# ğŸ’¡ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ä½¿ç”¨ã™ã‚‹è¨­å®š
env:
  # ç”Ÿæˆã•ã‚Œã‚‹çµåˆãƒ†ã‚­ã‚¹ãƒˆåã€‚Geminiã¯ã“ã®1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ã ã‘ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’æŠŠæ¡ã§ãã¾ã™
  OUTPUT_FILENAME: combined.txt
  # çµåˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹å°‚ç”¨ãƒ–ãƒ©ãƒ³ãƒã€‚masterã®å±¥æ­´ã‚’æ±šã•ãšã€AIç”¨ã®ã€Œæœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ã¨ã—ã¦é‹ç”¨ã—ã¾ã™
  TARGET_BRANCH: combine-code
  # è§£æå¯¾è±¡ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã€Œè«–ç†æ§‹é€ ã€ã‚’AIã«æ•™ãˆã‚‹ãŸã‚ .vcxproj ã¨ .filters ã‚’å«ã‚ã‚‹ã®ãŒé‡è¦ã§ã™
  TARGET_EXTENSIONS: .cpp,.h,.hpp,.vcxproj,.vcxproj.filters
  # å­¦ç”Ÿã®æˆæœç‰©ã§ã¯ãªã„å¤–éƒ¨ã‚³ãƒ¼ãƒ‰ã‚’é™¤å¤–ã€‚Debugãƒ•ã‚©ãƒ«ãƒ€ã¯ã‚½ãƒ¼ã‚¹ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚é™¤å¤–ã—ã¾ã›ã‚“
  EXCLUDE_DIRS: Resources,Novice,Adapter,DirectXTex,imgui,External,x64,Release,ipch

jobs:
  publish:
    runs-on: ubuntu-latest
    
    # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
    permissions:
      contents: write 

    steps:
      - name: Checkout master
        uses: actions/checkout@v4 

      # --- 1. Pythonã«ã‚ˆã‚‹æ–‡å­—åŒ–ã‘å¯¾ç­–è¾¼ã¿ã®é«˜åº¦ãªãƒ•ã‚¡ã‚¤ãƒ«çµåˆ ---
      - name: Generate Code Summary
        id: generate
        shell: python
        run: |
          import os
          
          # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
          target_extensions = tuple(os.environ['TARGET_EXTENSIONS'].split(','))
          exclude_dirs = set(os.environ['EXCLUDE_DIRS'].split(','))
          output_file = os.environ['OUTPUT_FILENAME']
          root_dir = '.'
          # Gitã‚„IDEã®ç®¡ç†ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¼·åˆ¶é™¤å¤–
          exclude_dirs.update({'.git', '.github', '.vs', 'build', 'out', '.vscode'})

          def read_file_safe(path):
              """
              æ—¥æœ¬ã®Visual Studioç’°å¢ƒç‰¹æœ‰ã®Shift-JIS(CP932)ã¨UTF-8ã®æ··åœ¨ã‚’è§£æ±ºã—ã¦èª­ã¿è¾¼ã‚€ã€‚
              æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã®æ–‡å­—åŒ–ã‘ã‚’é˜²ãã€AIãŒæ­£ã—ãèª­ã‚ã‚‹UTF-8ã¸å¤‰æ›ã—ã¾ã™ã€‚
              """
              encodings = ['utf-8-sig', 'cp932', 'utf-8']
              for enc in encodings:
                  try:
                      with open(path, 'r', encoding=enc) as f:
                          return f.read()
                  except (UnicodeDecodeError, UnicodeError):
                      continue
              # ã™ã¹ã¦ã®è©¦è¡ŒãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€å£Šã‚ŒãŸæ–‡å­—ã‚’ä»£æ›¿æ–‡å­—ã«ç½®ãæ›ãˆã¦å¼·åˆ¶èª­ã¿è¾¼ã¿
              with open(path, 'r', encoding='utf-8', errors='replace') as f:
                  return f.read()

          def generate_tree(startpath):
              """ç‰©ç†çš„ãªãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’å¯è¦–åŒ–ã€‚AIãŒã€Œã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã“ã«ã‚ã‚‹ã‹ã€ã‚’æŠŠæ¡ã™ã‚‹èµ·ç‚¹ã«ãªã‚Šã¾ã™"""
              lines = ["### ğŸŒ³ Codebase File Tree (Physical Structure)\n"]
              for root, dirs, files in os.walk(startpath):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  level = root.replace(startpath, '').count(os.sep)
                  indent = 'â”‚   ' * level
                  lines.append(f"{indent}â”œâ”€â”€ {os.path.basename(root) or '.'}/")
                  for f in files:
                      if f.endswith(target_extensions):
                          lines.append(f"{'â”‚   ' * (level + 1)}â””â”€â”€ {f}")
              return "\n".join(lines)

          # çµåˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆé–‹å§‹
          with open(output_file, 'w', encoding='utf-8') as out:
              # A. ç‰©ç†æ§‹é€ ã‚’æœ€ä¸Šéƒ¨ã«è¨˜è¿°
              out.write(generate_tree(root_dir))
              out.write("\n\n" + "="*60 + "\nFILE CONTENTS START BELOW\n" + "="*60 + "\n\n")

              all_paths = []
              for root, dirs, files in os.walk(root_dir):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  for f in files:
                      if f.endswith(target_extensions):
                          all_paths.append(os.path.join(root, f))

              # B. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆé ­ã«é…ç½®ã€‚AIãŒã€Œæ§‹æˆã€ã‚’ç†è§£ã—ãŸå¾Œã«ã€Œå®Ÿè£…ã€ã‚’èª­ã‚€æµã‚Œã‚’ä½œã‚Šã¾ã™
              all_paths.sort(key=lambda x: (not x.endswith('.vcxproj'), not x.endswith('.filters'), x))

              for path in all_paths:
                  rel_path = os.path.relpath(path, root_dir)
                  content = read_file_safe(path)
                  # XMLã‚¿ã‚°ã«ã‚ˆã‚‹ã‚«ãƒ—ã‚»ãƒ«åŒ–ã€‚AIãŒãƒ•ã‚¡ã‚¤ãƒ«å¢ƒç•Œã‚’100%æ­£ç¢ºã«è­˜åˆ¥ã§ãã¾ã™
                  out.write(f'<file_content path="{rel_path}">\n')
                  out.write(content)
                  out.write(f'\n</file_content>\n\n')

      # --- 2. å®‰å…¨ãªãƒ–ãƒ©ãƒ³ãƒå…¬é–‹å‡¦ç† ---
      - name: Publish to Target Branch
        env:
          # å¤‰æ•°å±•é–‹ã®ãƒŸã‚¹ã‚’é˜²ããŸã‚ã€ä¸€åº¦ã‚·ã‚§ãƒ«ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´
          OUT_F: ${{ env.OUTPUT_FILENAME }}
          TGT_B: ${{ env.TARGET_BRANCH }}
          SHA: ${{ github.sha }}
        run: |
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚é ˜åŸŸã«é€€é¿ï¼ˆGitã®ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆæ™‚ã®ç«¶åˆã‚’å®Œå…¨ã«å›é¿ï¼‰
          cp "$OUT_F" "/tmp/$OUT_F"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if git fetch origin "$TGT_B"; then
            git checkout -f "$TGT_B"
            git pull origin "$TGT_B"
          else
            # åˆå›ã¯å±¥æ­´ã‚’æŒãŸãªã„ç‹¬ç«‹ãƒ–ãƒ©ãƒ³ãƒ(orphan)ã‚’ä½œæˆ
            git checkout --orphan "$TGT_B"
            git rm -rf .
          fi
          
          # é€€é¿ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ã¦ã‚³ãƒŸãƒƒãƒˆ
          mv "/tmp/$OUT_F" .
          git add "$OUT_F"
          
          if ! git diff --cached --exit-code; then
            git commit -m "Auto: Update combined code for AI review ($SHA)"
            git push origin "$TGT_B"
          else
            echo "No changes to commit"
          fi