name: Generate & Publish Combined Code File

on:
  # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches:
      - master
  # Actionsã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•ã§ã®å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# ğŸ’¡ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°
env:
  # ç”Ÿæˆã•ã‚Œã‚‹çµåˆãƒ†ã‚­ã‚¹ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«åã€‚Gemini APIã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™
  OUTPUT_FILENAME: combined.txt
  # çµåˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹å°‚ç”¨ãƒ–ãƒ©ãƒ³ãƒã€‚ãƒ¡ã‚¤ãƒ³å±¥æ­´ã‚’æ±šã•ãšAIãŒã‚¢ã‚¯ã‚»ã‚¹ã—ã‚„ã™ãã—ã¾ã™
  TARGET_BRANCH: combine-code
  # è§£æå¯¾è±¡ã®æ‹¡å¼µå­ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã‚’æŠŠæ¡ã™ã‚‹ãŸã‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (.vcxproj, .filters) ã‚’å«ã‚ã¾ã™
  TARGET_EXTENSIONS: .cpp,.h,.hpp,.vcxproj,.vcxproj.filters
  # å­¦ç”Ÿè‡ªèº«ã®æˆæœç‰©ã§ã¯ãªã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å¤–ã€‚
  # â€» Debugã¯å­¦ç”ŸãŒãƒ‡ãƒãƒƒã‚°ç”¨ã‚¯ãƒ©ã‚¹ã‚’å…¥ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚é™¤å¤–ãƒªã‚¹ãƒˆã‹ã‚‰å¤–ã—ã¦ã„ã¾ã™ã€‚
  EXCLUDE_DIRS: Resources,Novice,Adapter,DirectXTex,imgui,External,x64,Release,ipch

jobs:
  publish:
    runs-on: ubuntu-latest
    
    # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ›¸ãè¾¼ã¿ï¼‰æ¨©é™
    permissions:
      contents: write 

    steps:
      - name: Checkout master
        uses: actions/checkout@v4 

      # --- 1. Pythonã«ã‚ˆã‚‹é«˜åº¦ãªãƒ•ã‚¡ã‚¤ãƒ«çµåˆ ---
      - name: Generate Code Summary
        id: generate
        shell: python
        run: |
          import os
          
          # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
          target_extensions = tuple(os.environ['TARGET_EXTENSIONS'].split(','))
          exclude_dirs = set(os.environ['EXCLUDE_DIRS'].split(','))
          output_file = os.environ['OUTPUT_FILENAME']
          root_dir = '.'
          # ã‚·ã‚¹ãƒ†ãƒ ç³»ã®é™¤å¤–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¼·åˆ¶è¿½åŠ 
          exclude_dirs.update({'.git', '.github', '.vs', 'build', 'out', '.vscode'})

          def generate_tree_string(startpath):
              """AIãŒç‰©ç†ãƒ•ã‚©ãƒ«ãƒ€éšå±¤ã‚’ä¸€ç›®ã§æŠŠæ¡ã™ã‚‹ãŸã‚ã®ãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆ"""
              tree_lines = ["### ğŸŒ³ Codebase File Tree (Physical Structure)\n"]
              for root, dirs, files in os.walk(startpath):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  level = root.replace(startpath, '').count(os.sep)
                  indent = 'â”‚   ' * level
                  tree_lines.append(f"{indent}â”œâ”€â”€ {os.path.basename(root) or '.'}/")
                  sub_indent = 'â”‚   ' * (level + 1)
                  for f in files:
                      if f.endswith(target_extensions):
                          tree_lines.append(f"{sub_indent}â””â”€â”€ {f}")
              return "\n".join(tree_lines)

          with open(output_file, 'w', encoding='utf-8') as out:
              # A. æœ€åˆã«è¦‹ã‚‹ã¹ãæƒ…å ±ã¨ã—ã¦ç‰©ç†ãƒ„ãƒªãƒ¼ã‚’è¨˜è¿°
              out.write(generate_tree_string(root_dir))
              out.write("\n\n" + "="*60 + "\nFILE CONTENTS START BELOW\n" + "="*60 + "\n\n")

              all_files = []
              for root, dirs, files in os.walk(root_dir):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  for file in files:
                      if file.endswith(target_extensions):
                          all_files.append(os.path.join(root, file))

              # B. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆé ­ã«é…ç½®ï¼ˆAIãŒå…ˆã«æ§‹æˆã¨ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’ç†è§£ã™ã‚‹ãŸã‚ï¼‰
              all_files.sort(key=lambda x: (
                  not x.endswith('.vcxproj'), 
                  not x.endswith('.filters'), 
                  x
              ))

              for path in all_files:
                  rel_path = os.path.relpath(path, root_dir)
                  try:
                      # Shift-JISç­‰ã®æ··åœ¨ã‚’è€ƒæ…®ã—ã€UTF-8(BOMä»˜å¯¾å¿œ)ã§èª­ã¿è¾¼ã¿ã€‚ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç½®æ›ã—ã¦ç¶™ç¶šã€‚
                      with open(path, 'r', encoding='utf-8-sig', errors='replace') as f:
                          content = f.read()
                          # pathå±æ€§ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€AIãŒç‰©ç†éšå±¤ã¨è«–ç†ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ­£ç¢ºã«æ¯”è¼ƒå¯èƒ½ã«ã™ã‚‹
                          out.write(f'<file_content path="{rel_path}">\n')
                          out.write(content)
                          out.write(f'\n</file_content>\n\n')
                  except Exception as e:
                      print(f"Error reading {rel_path}: {e}")

      # --- 2. å®‰å…¨ãªãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆã¨ãƒ—ãƒƒã‚·ãƒ¥ ---
      - name: Publish to Target Branch
        env:
          # GitHubã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚·ã‚§ãƒ«å¤‰æ•°ã«å¤‰æ›ï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›é¿ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰
          OUT_FILE: ${{ env.OUTPUT_FILENAME }}
          TGT_BR: ${{ env.TARGET_BRANCH }}
          G_SHA: ${{ github.sha }}
        run: |
          # A. ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆæ™‚ã®ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚ã€ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ™‚é€€é¿
          cp "$OUT_FILE" "/tmp/$OUT_FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # B. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã®æº–å‚™ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°orphanã§æ–°è¦ä½œæˆï¼‰
          if git fetch origin "$TGT_BR"; then
            git checkout -f "$TGT_BR"
            git pull origin "$TGT_BR"
          else
            git checkout --orphan "$TGT_BR"
            git rm -rf .
          fi
          
          # C. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ã¦ã‚³ãƒŸãƒƒãƒˆ
          mv "/tmp/$OUT_FILE" .
          git add "$OUT_FILE"
          
          if ! git diff --cached --exit-code; then
            git commit -m "Auto: Update combined code for AI review ($G_SHA)"
            git push origin "$TGT_BR"
          else
            echo "No changes to commit"
          fi