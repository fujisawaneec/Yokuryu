name: Generate & Publish Combined Code File

on:
  # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  push:
    branches:
      - master
  # Actionsã‚¿ãƒ–ã‹ã‚‰æ‰‹å‹•ã§ã®å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# ğŸ’¡ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°
env:
  # ç”Ÿæˆã•ã‚Œã‚‹çµåˆãƒ†ã‚­ã‚¹ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«å
  OUTPUT_FILENAME: combined.txt
  # çµåˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®å°‚ç”¨ãƒ–ãƒ©ãƒ³ãƒ
  TARGET_BRANCH: combine-code
  # AIè§£æç”¨ã®å¯¾è±¡æ‹¡å¼µå­
  TARGET_EXTENSIONS: .cpp,.h,.hpp,.vcxproj,.vcxproj.filters
  # é™¤å¤–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  EXCLUDE_DIRS: Resources,Novice,Adapter,DirectXTex,imgui,External

jobs:
  publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
      - name: Checkout master
        uses: actions/checkout@v4 

      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰çµåˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ (Python)
      - name: Generate Code Summary
        id: generate
        shell: python
        run: |
          import os
          
          target_extensions = tuple(os.environ['TARGET_EXTENSIONS'].split(','))
          exclude_dirs = set(os.environ['EXCLUDE_DIRS'].split(','))
          output_file = os.environ['OUTPUT_FILENAME']
          root_dir = '.'
          exclude_dirs.update({'.git', '.github', '.vs', 'build', 'out'})

          def generate_tree_string(startpath):
              tree_lines = ["### ğŸŒ³ Codebase File Tree (Physical Structure)\n"]
              for root, dirs, files in os.walk(startpath):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  level = root.replace(startpath, '').count(os.sep)
                  indent = 'â”‚   ' * level
                  tree_lines.append(f"{indent}â”œâ”€â”€ {os.path.basename(root) or '.'}/")
                  sub_indent = 'â”‚   ' * (level + 1)
                  for f in files:
                      if f.endswith(target_extensions):
                          tree_lines.append(f"{sub_indent}â””â”€â”€ {f}")
              return "\n".join(tree_lines)

          with open(output_file, 'w', encoding='utf-8') as out:
              out.write(generate_tree_string(root_dir))
              out.write("\n\n" + "="*60 + "\nFILE CONTENTS START BELOW\n" + "="*60 + "\n\n")

              all_files = []
              for root, dirs, files in os.walk(root_dir):
                  dirs[:] = [d for d in dirs if d not in exclude_dirs]
                  for file in files:
                      if file.endswith(target_extensions):
                          all_files.append(os.path.join(root, file))

              # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ªå…ˆã—ã¦ä¸¦ã³æ›¿ãˆ
              all_files.sort(key=lambda x: (not x.endswith('.vcxproj'), not x.endswith('.filters'), x))

              for path in all_files:
                  rel_path = os.path.relpath(path, root_dir)
                  try:
                      with open(path, 'r', encoding='utf-8', errors='ignore') as f:
                          content = f.read()
                          out.write(f'<file_content path="{rel_path}">\n')
                          out.write(content)
                          out.write(f'\n</file_content>\n\n')
                  except Exception as e:
                      print(f"Error reading {rel_path}: {e}")

      # 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®å®‰å…¨ãªå…¬é–‹ (Shell)
      - name: Publish to Target Branch
        env:
          # GitHubå¤‰æ•°ã‚’ã‚·ã‚§ãƒ«ã®ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®‰å…¨ã«å—ã‘æ¸¡ã™
          OUT_FILE: ${{ env.OUTPUT_FILENAME }}
          TGT_BR: ${{ env.TARGET_BRANCH }}
          G_SHA: ${{ github.sha }}
        run: |
          # A. ä¸€æ™‚å¾…é¿ï¼ˆã‚·ã‚§ãƒ«å¤‰æ•°ã¨ã—ã¦å‚ç…§ï¼‰
          cp "$OUT_FILE" "/tmp/$OUT_FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # B. ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆ
          if git fetch origin "$TGT_BR"; then
            git checkout -f "$TGT_BR"
            git pull origin "$TGT_BR"
          else
            git checkout --orphan "$TGT_BR"
            git rm -rf .
          fi
          
          # C. ãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒã¨ãƒ—ãƒƒã‚·ãƒ¥
          mv "/tmp/$OUT_FILE" .
          git add "$OUT_FILE"
          
          if ! git diff --cached --exit-code; then
            git commit -m "Auto: Update combined code for AI review ($G_SHA)"
            git push origin "$TGT_BR"
          else
            echo "No changes to commit"
          fi